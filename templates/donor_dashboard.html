{% extends 'base.html' %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div class="max-w-4xl mx-auto relative">

    <div class="flex justify-center mb-8 bg-white rounded-full shadow p-1 w-fit mx-auto">
        <button onclick="switchTab('new')" id="tab-new" class="px-6 py-2 rounded-full text-sm font-bold bg-green-600 text-white shadow transition">
            ‚ûï New Donation
        </button>
        <button onclick="switchTab('pickups')" id="tab-pickups" class="px-6 py-2 rounded-full text-sm font-bold text-gray-500 hover:bg-gray-100 transition">
            üöö Live Pickups
        </button>
        <button onclick="switchTab('history')" id="tab-history" class="px-6 py-2 rounded-full text-sm font-bold text-gray-500 hover:bg-gray-100 transition">
            üìú My History
        </button>
        <button onclick="switchTab('profile')" id="tab-profile" class="px-6 py-2 rounded-full text-sm font-bold text-gray-500 hover:bg-gray-100 transition">
            üë§ My Profile
        </button>
    </div>

    <div id="view-new" class="tab-content bg-white p-8 rounded-xl shadow-md border border-gray-100">
        <h2 class="text-2xl font-bold mb-6 text-gray-800 text-center">üç≤ Donate Food</h2>
        
        <form id="donationForm" class="space-y-5">
                
                <input type="hidden" name="current_temperature" id="hidden-temp" value="25">

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Food Name</label>
                    <input type="text" name="food_name" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none" placeholder="e.g. Rice & Curry" required>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Description</label>
                    <textarea name="description" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none" rows="2" placeholder="e.g. Leftover from lunch..." required></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Quantity (kg)</label>
                        <input type="number" step="0.1" name="quantity_kg" class="w-full p-3 border rounded-lg" placeholder="5.0" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Food Type</label>
                        <select name="food_type" class="w-full p-3 border rounded-lg">
                            <option value="Vegetarian">Vegetarian</option>
                            <option value="Non-Veg">Non-Veg</option>
                            <option value="Vegan">Vegan</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Time Since Cooked (Hours)</label>
                        <input type="number" name="time_since_cooking_hours" class="w-full p-3 border rounded-lg" placeholder="Total age (e.g. 3)" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Storage Time (Hours)</label>
                        <input type="number" name="storage_time_hours" class="w-full p-3 border rounded-lg bg-yellow-50" placeholder="Time in container (e.g. 1)" required>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Storage Condition</label>
                    <select name="storage_condition" class="w-full p-3 border rounded-lg">
                        <option value="refrigerated">Refrigerated (Cold)</option>
                        <option value="room_temperature">Room Temp (Normal)</option>
                        <option value="heated">Heated (Hot)</option>
                    </select>
                </div>
                
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm font-bold text-gray-700">Pickup Address</label>
                        <button type="button" onclick="getLiveLocationForDonation()" class="text-xs bg-blue-100 text-blue-700 hover:bg-blue-200 px-3 py-1 rounded-full font-bold transition flex items-center gap-1 border border-blue-200 shadow-sm">
                            üìç Auto-Fill Address & Temp
                        </button>
                    </div>
                    <textarea name="pickup_address" id="donate-address" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500" rows="2" placeholder="Click 'Auto-Fill' or type manually..." required></textarea>
                    <p id="temp-display" class="text-xs text-gray-400 mt-1 text-right italic">üå°Ô∏è Temperature will be detected automatically</p>
                </div>

                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform hover:scale-[1.02]">
                    üöÄ Analyze & Donate
                </button>
            </form>
    </div>

    <div id="view-pickups" class="tab-content hidden">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">üöö Active Pickups</h2>
        <div id="pickup-list" class="space-y-4"></div>
    </div>

    <div id="view-history" class="tab-content hidden">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">My Past Contributions</h2>
        <div id="history-list" class="space-y-4"></div>
    </div>

    <div id="view-profile" class="tab-content hidden bg-white p-8 rounded-xl shadow-md border border-gray-100">
        <h2 class="text-2xl font-bold mb-6 text-gray-800 text-center">üë§ My Profile & Location</h2>
        <div class="flex items-center gap-4 mb-8 p-4 bg-green-50 rounded-lg">
            <div class="w-16 h-16 bg-green-200 rounded-full flex items-center justify-center text-3xl">üç≤</div>
            <div>
                <h3 class="font-bold text-xl">{{ user.username }}</h3>
                <p class="text-sm text-gray-600">{{ user.email }}</p>
                <span class="text-xs bg-green-600 text-white px-2 py-1 rounded">Donor Account</span>
            </div>
        </div>

        <form id="profileForm" class="space-y-5">
            <div class="p-4 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-700">üìç Live Location</h3>
                    <button type="button" onclick="getLiveLocation()" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-2 rounded shadow transition flex items-center gap-1">
                        <i class="fas fa-location-arrow"></i> Detect Location
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500">Latitude</label>
                        <input type="text" id="prof-lat" name="latitude" value="{{ user.latitude|default:'' }}" class="w-full p-2 border rounded bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">Longitude</label>
                        <input type="text" id="prof-lng" name="longitude" value="{{ user.longitude|default:'' }}" class="w-full p-2 border rounded bg-gray-100" readonly>
                    </div>
                </div>
                <div class="mt-4 flex items-center gap-3">
                    <div class="text-3xl">üå°Ô∏è</div>
                    <div>
                        <p class="text-xs font-bold text-gray-500">Live Temperature (at your location)</p>
                        <p id="live-temp" class="text-lg font-bold text-gray-800">-- ¬∞C</p>
                    </div>
                </div>
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">Permanent Address</label>
                <textarea name="address" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" rows="3" placeholder="Enter your full address here...">{{ user.address|default:'' }}</textarea>
            </div>
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition">
                üíæ Save Profile
            </button>
        </form>
    </div>

</div>

<div id="map-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col relative">
        <button onclick="closeMap()" class="absolute top-4 right-4 z-[9999] bg-white text-red-600 font-bold p-2 rounded-full shadow hover:bg-red-50">‚úñ Close</button>
        <div class="p-4 border-b bg-gray-50 rounded-t-xl">
            <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                üöö Live Tracking <span class="text-sm font-normal text-gray-500 ml-2">(Blue = You, Red = NGO)</span>
            </h3>
        </div>
        <div id="tracking-map" class="flex-grow w-full h-full rounded-b-xl"></div>
    </div>
</div>

<div id="ai-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center">
        <div id="ai-icon-bg" class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <span id="ai-icon" class="text-4xl">ü•ó</span>
        </div>
        <h3 class="text-2xl font-bold text-gray-800 mb-2">AI Analysis Complete!</h3>
        <div class="my-6">
            <p class="text-sm text-gray-500 uppercase tracking-widest font-bold">Freshness Score</p>
            <div id="ai-score" class="text-5xl font-extrabold text-green-600 mt-1">98%</div>
        </div>
        <div id="ai-label-box" class="bg-green-50 text-green-800 px-4 py-2 rounded-lg font-bold inline-block mb-6">‚úÖ Safe to Eat</div>
        <button onclick="closeModal()" class="w-full bg-gray-900 text-white font-bold py-3 rounded-xl hover:bg-gray-800 transition shadow-lg">Awesome! Show History</button>
    </div>
</div>

<script>
    let map = null;

    // --- TAB SWITCHING ---
    function switchTab(name) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(`view-${name}`).classList.remove('hidden');
        
        ['new', 'pickups', 'history', 'profile'].forEach(n => {
            document.getElementById(`tab-${n}`).className = "px-6 py-2 rounded-full text-sm font-bold text-gray-500 hover:bg-gray-100 transition";
        });

        const activeBtn = document.getElementById(`tab-${name}`);
        activeBtn.className = "px-6 py-2 rounded-full text-sm font-bold bg-green-600 text-white shadow transition";
        if(name !== 'new') { activeBtn.classList.replace('bg-green-600', 'bg-blue-600'); }
        
        if(name === 'pickups') loadPickups();
        if(name === 'history') loadHistory();
    }

    // --- 1. DONATION FORM LOGIC ---
    document.getElementById('donationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = this.querySelector('button');
        const originalText = btn.innerText;
        btn.innerText = "ü§ñ AI is Analyzing...";
        btn.disabled = true;

        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch('/api/donations/create/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
                body: JSON.stringify(data)
            });

            if(response.ok) {
                const result = await response.json();
                showAIResult(result.freshness_score, result.freshness_label);
                this.reset();
            } else {
                const err = await response.json();
                alert("‚ùå Error: " + JSON.stringify(err));
            }
        } catch(e) { console.error(e); } 
        finally { btn.innerText = originalText; btn.disabled = false; }
    });

    // --- 2. LIVE PICKUPS & MAP LOGIC (FIXED!) ---
    async function loadPickups() {
        const container = document.getElementById('pickup-list');
        container.innerHTML = '<p class="text-center text-gray-400">Scanning for pickups...</p>';
        
        try {
            const response = await fetch('/api/donations/list/');
            const data = await response.json();
            container.innerHTML = '';

            const pickups = data.filter(d => d.status === 'claimed');

            if(pickups.length === 0) {
                container.innerHTML = '<div class="text-center py-10"><p class="text-gray-500">No active pickups right now.</p></div>';
                return;
            }

            pickups.forEach(d => {
                // üü¢ FIXED: Using 'recipient_details' instead of 'claimed_by_details'
                const details = d.recipient_details;
                
                const ngoName = details ? details.username : "Unknown NGO";
                const ngoPhone = (details && details.phone) ? details.phone : "No Phone";
                
                // Get Coordinates
                const ngoLat = details ? details.latitude : null;
                const ngoLng = details ? details.longitude : null;
                const myLat = d.lat;
                const myLng = d.lng;

                let mapBtn = '';
                if(ngoLat && ngoLng && myLat && myLng) {
                    mapBtn = `<button onclick="openMap(${myLat}, ${myLng}, ${ngoLat}, ${ngoLng}, '${ngoName}')" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold px-4 py-2 rounded shadow flex items-center gap-2">
                                <i class="fas fa-map-marked-alt"></i> Track Map
                              </button>`;
                } else {
                    mapBtn = `<span class="text-xs text-gray-400">Location Unavailable</span>`;
                }

                const card = `
                    <div class="bg-white p-5 rounded-lg shadow-md border-l-4 border-green-500 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex-grow">
                            <h3 class="font-bold text-xl text-gray-800">${d.food_name}</h3>
                            <p class="text-sm text-gray-500 mb-2">Claimed by: <span class="font-bold text-green-700">${ngoName}</span></p>
                            <div class="text-sm bg-gray-50 p-2 rounded border inline-block">
                                <p>üìû Phone: ${ngoPhone}</p>
                                <p>üì¶ Quantity: ${d.quantity_kg} kg</p>
                            </div>
                        </div>
                        <div>${mapBtn}</div>
                    </div>`;
                container.innerHTML += card;
            });
        } catch(e) { console.error(e); }
    }

    function openMap(myLat, myLng, ngoLat, ngoLng, ngoName) {
        document.getElementById('map-modal').classList.remove('hidden');

        if (!map) {
            map = L.map('tracking-map');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
        }

        setTimeout(() => { map.invalidateSize(); }, 200);

        map.eachLayer((layer) => { if (!!layer.toGeoJSON) { map.removeLayer(layer); } });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        L.marker([myLat, myLng]).addTo(map).bindPopup("<b>üè† You (Pickup Point)</b>").openPopup();

        var redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/markers-default/red-2x.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
        });
        L.marker([ngoLat, ngoLng], {icon: redIcon}).addTo(map).bindPopup(`<b>üöö ${ngoName}</b><br>Is on the way!`);

        var bounds = L.latLngBounds([[myLat, myLng], [ngoLat, ngoLng]]);
        map.fitBounds(bounds, {padding: [50, 50]});
    }

    function closeMap() { document.getElementById('map-modal').classList.add('hidden'); }

    // --- 3. PROFILE LOGIC ---
    function getLiveLocation() {
        const btn = document.querySelector('button[onclick="getLiveLocation()"]');
        btn.innerText = "‚åõ Detecting...";
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else { alert("Geolocation not supported."); }
    }

    async function showPosition(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        
        document.getElementById('prof-lat').value = lat;
        document.getElementById('prof-lng').value = lng;

        // 1. Fetch Weather & SAVE IT TO FORM
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`);
            const data = await res.json();
            const temp = data.current_weather.temperature;
            
            // Update UI
            document.getElementById('live-temp').innerText = `${temp} ¬∞C`;
            
            // üü¢ CRITICAL: Save temp to hidden input so it goes to Backend
            document.getElementById('hidden-temp').value = temp; 
            
        } catch(e) { console.error("Weather Error", e); }

        // ... (rest of your address fetching code) ...
    }

    function showError(error) {
        alert("‚ö†Ô∏è Location Error: " + error.message);
        document.querySelector('button[onclick="getLiveLocation()"]').innerHTML = '<i class="fas fa-location-arrow"></i> Detect Location';
    }

    document.getElementById('profileForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(this).entries());
        try {
            const response = await fetch('/api/users/profile/update/', {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
                body: JSON.stringify(data)
            });
            if(response.ok) alert("‚úÖ Profile Updated Successfully!");
        } catch(e) {}
    });

    // --- 4. AI & HISTORY LOGIC ---
    function showAIResult(score, label) {
        const modal = document.getElementById('ai-modal');
        const scoreEl = document.getElementById('ai-score');
        const labelBox = document.getElementById('ai-label-box');
        const finalScore = Math.round(score);
        scoreEl.innerText = finalScore + "%";
        labelBox.innerText = label;
        
        if(finalScore >= 70) {
            scoreEl.className = "text-5xl font-extrabold text-green-600 mt-1";
            labelBox.className = "bg-green-100 text-green-800 px-4 py-2 rounded-lg font-bold inline-block mb-6";
        } else if (finalScore >= 40) {
            scoreEl.className = "text-5xl font-extrabold text-yellow-600 mt-1";
            labelBox.className = "bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg font-bold inline-block mb-6";
        } else {
            scoreEl.className = "text-5xl font-extrabold text-red-600 mt-1";
            labelBox.className = "bg-red-100 text-red-800 px-4 py-2 rounded-lg font-bold inline-block mb-6";
        }
        modal.classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('ai-modal').classList.add('hidden');
        switchTab('history');
    }

    async function loadHistory() {
        const container = document.getElementById('history-list');
        container.innerHTML = '<p class="text-center text-gray-400">Loading...</p>';
        try {
            const response = await fetch('/api/donations/list/');
            const data = await response.json();
            container.innerHTML = '';
            data.forEach(d => {
                let statusBadge = d.status === 'pending' 
                    ? '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full font-bold">‚è≥ Pending</span>'
                    : '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-bold">‚úÖ Claimed</span>';
                let freshnessDot = d.freshness_score >= 70 ? 'üü¢' : (d.freshness_score >= 40 ? 'üü°' : 'üî¥');

                const card = `
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 ${d.status === 'pending' ? 'border-yellow-400' : 'border-green-500'} flex justify-between items-center hover:shadow-md transition">
                        <div>
                            <h3 class="font-bold text-lg flex items-center gap-2">${d.food_name} <span class="text-xs text-gray-400 font-normal">(${d.freshness_label})</span></h3>
                            <p class="text-sm text-gray-500">${freshnessDot} Score: ${Math.round(d.freshness_score)}% ‚Ä¢ ${d.quantity_kg}kg</p>
                        </div>
                        <div>${statusBadge}</div>
                    </div>`;
                container.innerHTML += card;
            });
            if(container.innerHTML === '') container.innerHTML = '<p>No donations yet.</p>';
        } catch(e) { console.error(e); }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    // --- FUNCTION: Auto-Fill Address & Temp ---
    function getLiveLocationForDonation() {
        // 1. Change button text to show loading
        const btn = document.querySelector('button[onclick="getLiveLocationForDonation()"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = "‚åõ Detecting...";
        
        // 2. Get GPS Coordinates
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                // 3. Fetch Temperature (Open-Meteo API)
                try {
                    const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`);
                    const weatherData = await weatherRes.json();
                    const temp = weatherData.current_weather.temperature;
                    
                    // Update Hidden Input & Display Text
                    document.getElementById('hidden-temp').value = temp;
                    const display = document.getElementById('temp-display');
                    display.innerText = `üå°Ô∏è Detected Temp: ${temp}¬∞C (Used for AI Analysis)`;
                    display.className = "text-xs text-green-600 font-bold mt-1 text-right";
                } catch(e) { console.error("Weather Error", e); }

                // 4. Fetch Address (OpenStreetMap API)
                try {
                    const addrRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                    const addrData = await addrRes.json();
                    if(addrData.display_name) {
                        document.getElementById('donate-address').value = addrData.display_name;
                    }
                } catch(e) { console.error("Address Error", e); }

                // 5. Reset Button Text
                btn.innerHTML = "‚úÖ Applied!";
                setTimeout(() => { btn.innerHTML = originalText; }, 2000);

            }, (error) => {
                alert("‚ö†Ô∏è GPS Error: " + error.message);
                btn.innerHTML = originalText;
            });
        } else {
            alert("Geolocation is not supported.");
        }
    }
</script>
{% endblock %}